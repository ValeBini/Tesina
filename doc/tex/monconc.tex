\chapter{M\'onadas Concurrentes}\label{chapter:monconc}


\section{Definiciones previas}\label{monconc:previas}

\subsection{Categorías}\label{previas:cat}
Una \textbf{categoría} $\mathscr{C}$ consiste de:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep,label=$\blacktriangleright$]
	\item una clase de \textbf{objetos}: $\mathbf{ob} \ \mathscr{C}$;
	\item una clase de \textbf{morfismos} o \textbf{flechas}: $\mathbf{mor} \ \mathscr{C}$;
	\item dos funciones de clase:
	\begin{itemize}[noitemsep,label=$\bullet$]
		\item $dom : \mathbf{mor} \ \mathscr{C} \rightarrow \mathbf{ob} \ \mathscr{C}$ (dominio),
		\item $codom : \mathbf{mor} \ \mathscr{C} \rightarrow \mathbf{ob} \ \mathscr{C}$ (codominio).
	\end{itemize}
	Para cada par de objetos $A, B$ en $\mathbf{ob} \ \mathscr{C}$ se denomina $Hom(A,B)$ al conjunto de flechas o morfismos de $A$ a $B$, es decir:
	\begin{equation*}
		Hom(A,B) := \{f \in \mathbf{mor} \ \mathscr{C} : dom(f) = A, codom(f) = B\}
	\end{equation*}
	\item Y para cada $A, B, C \in \mathbf{ob} \ \mathit{C}$ una operación  
	\begin{equation*}
		\circ : Hom(A,B) \times Hom(B,C) \rightarrow Hom(A,C)
	\end{equation*}
	llamada \textbf{composición} con las siguientes propiedades: 
	\begin{itemize}[noitemsep,label=$\bullet$]
		\item Se denota $\circ(f,g) = g \circ f$.
		\item \textbf{Asociatividad}: para cada $A,B,C,D \in \mathbf{ob} \ \mathscr{C}$ y $f,g,h \in \mathbf{mor} \ \mathscr{C}$ tales que $f \in Hom(A,B)$, $g \in Hom(B,C)$ y $h \in Hom(C,D)$, \ \ $h \circ (g \circ f) = (h \circ g) \circ f$.
		\item Para cada $A \in \mathbf{ob} \mathscr{C}$ existe un \textbf{morfismo identidad} $id_A \in Hom(A,A)$ tal que
		\begin{itemize}[noitemsep,label=$\star$]
			\item $\forall B, \ \forall f \in Hom(A,B), f \circ id_A = f$,
			\item $\forall C, \ \forall g \in Hom(C,A, id_A \circ g = g$.
		\end{itemize}
	\end{itemize}
	
\end{itemize}

\subsubsection{Ejemplos}
\paragraph{Categor\'ia Set} 
La categoría \textbf{Set} es aquella tal que:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep,label=$\blacktriangleright$]
	\item $\text{\bf ob Set} = \text{conjuntos}$
	\item $\text{\bf mor Set} = \text{funciones}$. 
\end{itemize}
\vspace{-0.75\baselineskip}
\paragraph{Categor\'ia $\mathds{1}$} 
La categoría $\mathds{1}$ es aquella tal que:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep,label=$\blacktriangleright$]
	\item $\text{\bf ob} \ \mathds{1} = \{\star\}$
	\item $\text{\bf mor} \ \mathds{1} = \{\text{id}_{\star}\}$. 
\end{itemize}

\subsubsection{Objetos iniciales y terminales}
Un objeto $\mathbf{0} \in \text{\bf ob}  \mathscr{C}$ se dice \textbf{inicial} si $\forall A \in \text{\bf ob} \mathscr{C}, \exists! \mathbf{0} \rightarrow A$. 

Un objeto $\mathbf{1} \in \text{\bf ob} \mathscr{C}$ se dice \textbf{terminal} si $\forall A \in \text{\bf ob} \mathscr{C}, \exists! A \rightarrow \mathbf{1}$.

\paragraph{Ejemplo} En \textbf{Set} $\emptyset$ es el único objeto inicial y los conjuntos de un elemento $\{x\}$ son los objetos terminales.
 
\subsection{Funtores}\label{previas:fun}
Sean $\mathscr{C}$ y $\mathscr{D}$ dos categorías. Un \textbf{funtor} $\mathit{F} : \mathscr{C} \rightarrow \mathscr{D}$ asigna:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep,label=$\blacktriangleright$]
	\item a cada objeto $A \in \mathbf{ob} \ \mathscr{C}$, un objeto $\mathit{F}(A) \in \mathbf{ob} \ \mathscr{D}$;
	\item a cada morfismo $f : A \rightarrow B \in \mathbf{mor} \ \mathscr{C}$, un morfismo $\mathit{F}(f) : \mathit{F}(A) \rightarrow \mathit{F}(B) \in \mathbf{mor} \ \mathscr{D}$ tal que: 
	\begin{itemize}[noitemsep,label=$\bullet$]
		\item para todo $A \in \mathbf{ob} \ \mathscr{C}$, $\mathit{F}(id_A) = id_{\mathit{F}(A)}$;
		\item para todos $f,g \in \mathbf{mor} \ \mathscr{C}$ tales que tenga sentido la composición $g \circ f$, se tiene $\mathit{F}(g \circ f) = \mathit{F}(g) \circ \mathit{F}(f)$.
	\end{itemize}
\end{itemize}

\subsection{Transformaciones Naturales}\label{previas:transfnat}
Sean $\mathit{F}, \mathit{G} : \mathscr{C} \rightarrow \mathscr{D}$ dos funtores (entre las mismas categorías). Una \textbf{transformación natural} $\eta : \mathit{F} \rightarrow \mathit{G}$ asigna a cada $A \in \mathbf{ob} \ \mathscr{C}$ un morfismo $\eta_A : \mathit{F}(A) \rightarrow \mathit{G}(A)$ tal que para todo $f \in Hom(A,B)$ se cumple que: 
\begin{equation*}
	\eta_B \circ \mathit{F}(f) = \mathit{G}(f) \circ \eta_A 
\end{equation*}

\subsection{Monoides}\label{previas:monoid}
Un \textbf{monoide} es un conjunto $M$ dotado de una operación asociativa $M \times M \rightarrow M$, $(m,n) \rightarrow mn$ tal que existe un elemento neutro:
\begin{equation*}
\exists e \in M, \forall m \in M, (em = me = m).
\end{equation*}

\section{Introducción a las mónadas}\label{monconc:monadas}

Se considerarán dos variantes de la definición de mónadas. La primera es la definición clásica y la segunda define a una mónada como un sistema de extensión o 3-tupla Kleisli. La primera es muy utilizada en la literatura ya que es la definición matemática y está definida en torno a transformaciones naturales, pero la segunda es más fácil de utilizar desde una perspectiva computacional. Como ambas definiciones son equivalentes \cite{moggi:1991}, se utilizará una u otra según sea conveniente.

\subsection{Definición clásica de Mónadas}\label{monadas:usual}

Dada una categoría $\mathscr{C}$, una mónada sobre $\mathscr{C}$ es una tupla $(\mathit{T},\mu,\eta)$, donde:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep,label=$\blacktriangleright$]
	\item $\mathit{T} : \mathscr{C} \rightarrow \mathscr{C}$ es un funtor,
	\item $\eta : \mathit{Id} \rightarrow \mathit{T}$ y $\mu : \mathit{T} \cdot \mathit{T} \rightarrow \mathit{T}$ son transformaciones naturales
	\item y se cumplen las siguientes identidades:
	\begin{equation*}
		\mu_X \circ \mathit{T}\mu_X = \mu_X \circ \mu_{\mathit{T}X} \text{, } \qquad \mu_X \circ \mathit{T}\eta_X = id_{\mathit{T}X} \text{, } \qquad 
		\mu_X \circ \eta_{\mathit{T}X} = id_{\mathit{T}X} 
	\end{equation*}
\end{itemize}

\subsubsection{Ejemplos de mónadas sobre la categoría Set}
\vspace{-0.75\baselineskip}
\paragraph{M\'onada \textit{Error}}
Sea $\mathit{T} : \text{\bf Set} \rightarrow \text{\bf Set}$ el funtor $\mathit{T} X = X + E$, donde $E$ es un conjunto de errores. Intuitivamente un elemento de $\mathit{T} X$ puede ser un elemento de $X$ (un valor) o un error pertenenciente a $E$. Luego se definen $\eta$ y $\mu$ como siguen:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep, label=$\blacktriangleright$]
	\item Para cada conjunto $X$, se define $\eta_X : \mathit{Id} X \rightarrow \mathit{T} X$ como $\eta_X (x) = inl(x)$.
	\item Para cada conjunto $X$, se define $\mu_X : \mathit{T T} X \rightarrow \mathit{T} X$ como $\mu_X (inl(tx)) = tx$ si $tx \in X + E$ y $\mu_X (inr(e)) = inr(e)$ si $e \in E$. Es decir que si se tiene un error se propaga el error y si se tiene un elemento de $\mathit{T} X$ se devuelve dicho elemento. 
\end{itemize}

\paragraph{M\'onada \textit{State}}
Sea $\mathit{T} : \text{\bf Set} \rightarrow \text{\bf Set}$ el funtor $\mathit{T} X = (X \times S)^S$, donde $S$ es un conjunto no vacío de estados. Intuitivamente, $\mathit{T} X$ es una computación que toma un estado y retorna el valor resultante junto con el estado modificado. Luego se definen $\eta$ y $\mu$ como sigue:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep, label=$\blacktriangleright$]
	\item Para cada conjunto $X$, se define $\eta_X : \mathit{Id} X \rightarrow \mathit{T} X$ como $\eta_X (x) = (\lambda s : S . \langle x , s \rangle)$.
	\item Para cada conjunto $X$, se define $\mu_X : \mathit{T T} X \rightarrow \mathit{T} X$ como \\ \mbox{$\mu_X (f) = (\lambda s : S .$ let $\langle f' , s' \rangle = f(s)$ in $f'(s'))$}, es decir que $\mu_X (f)$ es la computación que, dado un estado $s$, primero computa el par computación-estado $f(s) = \langle f' , s' \rangle$ y luego retorna el par valor-estado $f'(s') = \langle x , s'' \rangle$.   
\end{itemize}

\subsection{Definición alternativa de Mónadas}\label{monadas:alt}
Una \textbf{3-tupla Kleisli} sobre una categoría $\mathscr{C}$ es una tupla $(\mathit{T},\eta,\_^*)$, donde 
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep,label=$\blacktriangleright$]
	\item $\mathit{T} : \mathbf{ob} \ \mathscr{C} \rightarrow \mathbf{ob} \ \mathscr{C}$,
	\item para cada $A \in \mathbf{ob} \ \mathscr{C}$, $\eta_A : A \rightarrow \mathit{T}A$,
	\item para cada $f : A \rightarrow \mathit{T}B$,  $f^* : \mathit{T}A \rightarrow \mathit{T}B$,
	\item y se cumplen las siguientes ecuaciones:
	\begin{itemize}[noitemsep,label=$\bullet$]
		\item $\eta^*_A = id_{\mathit{T}A}$
		\item $\eta_A ; f^* = f$ para cada $f : A \rightarrow \mathit{T}B$
		\item $f^* ; g^* = (f ; g^*)^*$ para cada $f : A \rightarrow \mathit{T}B$ y $g : B \rightarrow \mathit{T}C$.
	\end{itemize}
\end{itemize}

Intuitivamente $\eta_A$ es la inclusión de valores en computaciones (lo que en programación funcional usualmente se conoce como \textit{return}) y $f^*$ es la extensión de una función $f$ de valores a computaciones a una función de computaciones a computaciones, la cual primero evalúa una computación y luego aplica $f$ al valor resultante (lo que generalmente se conoce como \textit{bind} o $>$\hspace{-1mm}$>$\hspace{-1mm}$=$).

\subsubsection{Ejemplos definidos como 3-tupla Kleisli}
\vspace{-0.75\baselineskip}
\paragraph{M\'onada \textit{Error}} Tomando el funtor descripto en la versión clásica:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep, label=$\blacktriangleright$]
	\item Para cada conjunto $X$, se define $\eta_X : \mathit{Id} X \rightarrow \mathit{T} X$ como $\eta_X (x) = inl(x)$ al igual que en la versión clásica.
	\item Para cada función $f : X \rightarrow \mathit{T}Y$, se define $f^* : \mathit{T} X \rightarrow \mathit{T} Y$ como \mbox{$f^*(inl(x)) = f(x)$} si $x \in X$ y $f^*(inr(e)) = inr(e)$ si $e \in E$.   
\end{itemize}

\paragraph{M\'onada \textit{State}} Tomando el funtor descripto en la versión clásica:
\vspace{-0.75\baselineskip}
\begin{itemize}[noitemsep, label=$\blacktriangleright$]
	\item Para cada conjunto $X$, se define $\eta_X : \mathit{Id} X \rightarrow \mathit{T} X$ como $\eta_X (x) = (\lambda s : S . \langle x , s \rangle)$ al igual que en la primera versión.
	\item Para cada función $f : X \rightarrow \mathit{T}Y$, se define $f^* : \mathit{T} X \rightarrow \mathit{T} Y$ como \\ \mbox{$f^*(g) = (\lambda s : S .$ let $\langle x , s' \rangle = g(s)$ in $f(x)(s'))$}.
\end{itemize}

\subsection{Fortaleza de funtores y mónadas}\label{monadas:strength}
Un \textbf{funtor} $\mathit{F} : \mathscr{C} \rightarrow \mathscr{C}$  es \textbf{fuerte} si viene equipado con una transformación natural $\sigma_{X,Y} : \mathit{F}X \times Y \rightarrow \mathit{F} (X \times Y)$, de manera que se cumplen las siguientes ecuaciones:
\begin{equation*}
	\pi_1 = \mathit{F}(\pi_1) \circ \sigma_{X,\mathbf{1}} \text{, \quad} \sigma \circ (\sigma \times \text{id}) \circ \alpha = \mathit{F}(\alpha) \circ \sigma 
\end{equation*} 
donde $\pi_1$ y $\pi_2$ son las proyecciones del producto cartesiano y $\alpha = \langle \langle \pi_1 , \pi_1 \circ \pi_2 \rangle , \pi_2 \circ \pi_2 \rangle$ representa su asociatividad.

Una \textbf{mónada} $(\mathit{T},\mu,\eta)$ sobre $\mathscr{C}$ es \textbf{fuerte} si el funtor subyacente $\mathit{T}$ es fuerte y la fortaleza es compatible con $\mu$ y $\eta$: 
\begin{equation*}
\eta_{A \times B} = \sigma_{A,B} \circ (\eta_A \times \text{id}) \text{, \quad} \sigma_{A,B} \circ (\mu_A \times \text{id}) = \mu_{A \times B} \circ \mathit{T}\sigma_{A,B} \circ \sigma_{\mathit{T}A,B}
\end{equation*}

Hay una definición similar de fortaleza $\bar{\sigma}_{X,Y} : X \times \mathit{F}Y \rightarrow \mathit{F} (X \times Y)$ que actúa sobre el lado derecho, pero como el producto cartesiano es simétrico, se puede obtener de la fortaleza izquierda como $\bar{\sigma} = \mathit{F} \gamma \circ \sigma \circ \gamma$, donde $\gamma = \langle \pi_2 , \pi_1 \rangle$ intercambia los elementos del producto cartesiano.

\subsection{Estructuras monoidales}\label{monadas:monoidal}
Un \textbf{funtor monoidal} es un funtor $\mathit{F}: \mathscr{C} \rightarrow \mathscr{C}$ equipado con una estructura monoidal $(m,e)$, donde $m : \mathit{F} X \times \mathit{F} Y \rightarrow \mathit{F} (X \times Y)$ es una transformación natural y $e : \mathbf
{1} \rightarrow \mathit{F} \mathbf{1}$ es un morfismo tal que los diagramas de coherencia estándar conmutan. Además, si la estructura monoidal es compatible con $\gamma$, entonces el funtor monoidal es simétrico.

Una \textbf{mónada monoidal} es una mónada $(\textit{T},\mu,\eta)$ que tiene una estructura monoidal $(m,e)$ en su funtor subyacente $\mathit{T}$ tal que $e = \eta_{\mathbf{1}}$ y las estructuras monoidal y monádica son compatibles:
\begin{equation*}
\eta_{A \times B} = m_{A,B} \circ (\eta_A \times \eta_B) \text{, \quad} m_{A,B} \circ (\mu_A \times \mu_B) = \mu_{A \times B} \circ \mathit{T}m_{A,B} \circ m_{\mathit{T}A \times \mathit{T}B}.
\end{equation*}

\subsection{Mónadas conmutativas}\label{monads:commutative}
Dada una mónada fuerte $(\mathit{T},\mu,\eta)$, $\mathit{T}$ como funtor puede ser equipado con dos estructuras monoidales canóncas:
\begin{align*}
&\phi : \mathit{T}A \times \mathit{T}B \rightarrow \mathit{T} (A \times B) & &\psi : \mathit{T}A \times \mathit{T}B \rightarrow \mathit{T}(A \times B) \\
&\phi = \mu \circ \mathit{T}\bar{\sigma} \circ \sigma & &\psi = \mu \circ \mathit{T}\sigma \circ \bar{\sigma}
\end{align*}
y $e = \eta_1 : \mathbf{1} \rightarrow \mathit{T}\mathbf{1}$ en ambos casos. 

Se dice que una mónada es \textbf{conmutativa} cuando estas dos estructuras coinciden.

En esta tesina se utilizará la categoría \textbf{Set}, la cual es la categoría de conjuntos y funciones, y las mónadas que se presenten serán sobre esta categoría. El objeto terminal $\mathbf{1} = \{\star\}$ es un conjunto unitario. Una consecuencia particular de esto es que cualquier funtor $\mathit{F}$ y mónada $(\mathit{T},\mu,\eta)$ sobre esta categoría son fuertes, y cada uno admite una única fortaleza posible $\sigma$ ($\bar{\sigma}$). 

Por ejemplo, la mónada del conjunto partes $\mathcal{P}$ (y su variante finita $\mathcal{P}_f$) tiene fortaleza $\sigma(X,y) = X \times \{y\}$. En general, la fórmula de fortaleza de un funtor sobre \textbf{Set} puede ser expresada como $\sigma(v,y) = \mathit{F}(\lambda x : X . (x,y))(v)$. Cuando la mónada es conmutativa, hay sólo una estructura monoidal posible. En consecuencia, si una mónada es monoidal entonces es conmutativa \cite{kock:1970}. 